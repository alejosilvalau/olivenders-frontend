<div class="container my-4">
  <app-alert></app-alert>
  <div
    class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4"
  >
    <h2 class="mb-3 mb-md-0">WANDS MANAGEMENT</h2>
    <app-searcher
      [data]="wands"
      [filterAttributes]="[
        'name',
        'length_inches',
        'status',
        'profit',
        'total_price',
        'id'
      ]"
      (filteredData)="onSearch($event)"
      (searchTermChange)="searchTerm = $event"
      class="searcher"
    ></app-searcher>
    <app-add-button [modalTarget]="'#addWand'" [buttonText]="'Add Wand'" />
  </div>
  <app-data-table
    [columns]="[
      { key: 'id' ,label: 'ID' },
      { key: 'name', format: DataTableFormat.TitleCase, label: 'Name' },
      { key: 'image', label: 'Image' },
      { key: 'length_inches', label: 'Lenght' },
      { key: 'wood',subKey: 'name', format: DataTableFormat.TitleCase, label: 'Wood' },
      { key: 'core',subKey: 'name', format: DataTableFormat.TitleCase, label: 'Core' },
      { key: 'description', label: 'Description' },
      { key: 'status', format: DataTableFormat.TitleCase, label: 'Status' },
      { key: 'profit', format: DataTableFormat.Currency, label: 'Profit' },
      { key: 'total_price', format: DataTableFormat.Currency, label: 'Price' }
    ]"
    [data]="filteredWands"
    [emptyMessage]="'There are no wands available.'"
    [editModalTarget]="'#editWand'"
    [removeModalTarget]="'#removeWand'"
    (selectedEntity)="onWandSelected($event)"
  >
  </app-data-table>
  <app-modal
    [config]="{
      id: 'addWand',
      title: 'New Wand',
      submitButtonText: 'Create Wand',
      cancelButtonText: 'Cancel'
    }"
    (onSubmit)="addWand()"
    (onCancel)="resetWandForm()"
  >
    <ng-template #modalContent>
      <form [formGroup]="wandForm">
        <div class="col-md-12">
          <label for="name">Name</label>
          <input
            type="text"
            formControlName="name"
            id="name"
            name="name"
            class="form-control"
            required
          />
          <label for="length_inches">Length on Inches</label>
          <input
            type="number"
            formControlName="length_inches"
            id="length_inches"
            name="length_inches"
            class="form-control"
            required
          />
          <label for="description">Description</label>
          <textarea
            formControlName="description"
            id="description"
            name="description"
            class="form-control"
            rows="4"
            required
          ></textarea>
          <label for="image">Image</label>
          <div
            class="image-drop-area border border-2 rounded d-flex flex-column align-items-center justify-content-center py-4 mb-3 pointer"
            (drop)="onImageDrop($event)"
            (dragover)="onImageDragOver($event)"
            role="button"
          >
            <i class="bi bi-cloud-arrow-up display-4 text-primary mb-2"></i>
            <p class="mb-2 fw-semibold text-secondary">Drag & drop an image here, or click to select</p>
            <input
              type="file"
              accept="image/*"
              (change)="onImageSelected($event)"
              style="display:none"
              #imageInput
            />
            <button type="button" class="btn btn-outline-primary btn-sm" (click)="imageInput.click()">Choose Image</button>
            <img *ngIf="previewUrl" [src]="previewUrl" alt="Preview" class="img-thumbnail mt-3" style="max-width: 120px;" />
          </div>
          <label for="profit">Profit</label>
          <input
            type="number"
            formControlName="profit"
            id="profit"
            name="profit"
            class="form-control"
            required
          />
          <app-entity-selector [entityControl]="woodFormControlField" [service]="woodService"
          [findOneByString]="woodService.findOneByName" label="Wood">
          <input type="hidden" formControlName="wood" />
          </app-entity-selector>
          <app-entity-selector [entityControl]="coreFormControlField" [service]="coreService"
            [findOneByString]="coreService.findOneByName" label="Core">
            <input type="hidden" formControlName="core" />
          </app-entity-selector>
        </div>
      </form>
    </ng-template>
  </app-modal>
  <app-modal
    [config]="{
      id: 'editWand',
      title: 'Edit Wand',
      submitButtonText: 'Save Changes',
      cancelButtonText: 'Cancel'
    }"
    (onSubmit)="editWand()"
    (onCancel)="resetWandForm()"
  >
    <ng-template #modalContent>
            <form [formGroup]="wandForm">
        <div class="col-md-12">
          <label for="name">Name</label>
          <input
            type="text"
            formControlName="name"
            id="name"
            name="name"
            class="form-control"
            required
          />
          <label for="length_inches">Length on Inches</label>
          <input
            type="number"
            formControlName="length_inches"
            id="length_inches"
            name="length_inches"
            class="form-control"
            required
          />
          <label for="description">Description</label>
          <textarea
            formControlName="description"
            id="description"
            name="description"
            class="form-control"
            rows="4"
            required
          ></textarea>
          <label for="image">Image</label>
          <div
            class="image-drop-area border border-2 rounded d-flex flex-column align-items-center justify-content-center py-4 mb-3 pointer"
            (drop)="onImageDrop($event)"
            (dragover)="onImageDragOver($event)"
            role="button"
          >
            <i class="bi bi-cloud-arrow-up display-4 text-primary mb-2"></i>
            <p class="mb-2 fw-semibold text-secondary">Drag & drop an image here, or click to select</p>
            <input
              type="file"
              accept="image/*"
              (change)="onImageSelected($event)"
              style="display:none"
              #imageInput
            />
            <button type="button" class="btn btn-outline-primary btn-sm" (click)="imageInput.click()">Choose Image</button>
            <img *ngIf="previewUrl" [src]="previewUrl" alt="Preview" class="img-thumbnail mt-3" style="max-width: 120px;" />
          </div>
          <label for="profit">Profit</label>
          <input
            type="number"
            formControlName="profit"
            id="profit"
            name="profit"
            class="form-control"
            required
          />
          <app-entity-selector [entityControl]="woodFormControlField" [service]="woodService"
          [findOneByString]="woodService.findOneByName" label="Wood">
          <input type="hidden" formControlName="wood" />
          </app-entity-selector>
          <app-entity-selector [entityControl]="coreFormControlField" [service]="coreService"
            [findOneByString]="coreService.findOneByName" label="Core">
            <input type="hidden" formControlName="core" />
          </app-entity-selector>
        </div>
      </form>
    </ng-template>
  </app-modal>
  <app-modal
    [config]="{
      id: 'removeWand',
      title: 'Remove Wand',
      submitButtonText: 'Confirm Delete',
      cancelButtonText: 'Cancel'
    }"
    (onSubmit)="removeWand()"
    (onCancel)="resetWandForm()"
  >
    <ng-template #modalContent>
      <div class="col-md-12">
        <p>Are you sure that you want to remove the wand?</p>
        <p><strong>Name:</strong> {{ selectedWand?.name | titlecase }}</p>
      </div>
    </ng-template>
  </app-modal>
</div>
